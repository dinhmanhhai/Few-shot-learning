"""
Module cho ph√¢n t√≠ch dataset
"""
import os
import numpy as np
import matplotlib.pyplot as plt

def create_class_distribution_chart(dataset_path, config):
    """
    T·∫°o ƒë·ªì th·ªã bar chart ri√™ng cho s·ªë l∆∞·ª£ng ·∫£nh theo t·ª´ng class
    """
    PLOT_DPI = config['PLOT_DPI']
    
    if not os.path.exists(dataset_path):
        print(f"‚ùå Th∆∞ m·ª•c {dataset_path} kh√¥ng t·ªìn t·∫°i!")
        return None
    
    print("üîç ƒêang t·∫°o ƒë·ªì th·ªã ph√¢n b·ªë class...")
    
    # L·∫•y th√¥ng tin c√°c class
    class_names = []
    class_counts = []
    
    for class_name in sorted(os.listdir(dataset_path)):
        class_path = os.path.join(dataset_path, class_name)
        if os.path.isdir(class_path):
            # ƒê·∫øm s·ªë file ·∫£nh trong class
            image_extensions = ['.jpg', '.jpeg', '.png', '.bmp', '.tiff', '.tif', '.gif', '.webp']
            count = 0
            for file in os.listdir(class_path):
                file_lower = file.lower()
                if any(file_lower.endswith(ext) for ext in image_extensions):
                    count += 1
            
            if count > 0:
                class_names.append(class_name)
                class_counts.append(count)
    
    if not class_names:
        print("‚ùå Kh√¥ng t√¨m th·∫•y ·∫£nh n√†o!")
        return None
    
    # T·∫°o ƒë·ªì th·ªã
    plt.figure(figsize=(12, 8))
    bars = plt.bar(range(len(class_names)), class_counts, color='skyblue', edgecolor='navy', alpha=0.7)
    plt.title('S·ªë l∆∞·ª£ng ·∫£nh theo t·ª´ng class', fontsize=16, fontweight='bold')
    plt.xlabel('Class', fontsize=12)
    plt.ylabel('S·ªë l∆∞·ª£ng ·∫£nh', fontsize=12)
    plt.xticks(range(len(class_names)), class_names, rotation=45, ha='right')
    
    # Th√™m s·ªë li·ªáu tr√™n bars
    for bar, count in zip(bars, class_counts):
        height = bar.get_height()
        plt.text(bar.get_x() + bar.get_width()/2., height + max(class_counts)*0.01,
                f'{count}', ha='center', va='bottom', fontweight='bold')
    
    # Th√™m ƒë∆∞·ªùng trung b√¨nh
    avg_count = np.mean(class_counts)
    plt.axhline(y=avg_count, color='red', linestyle='--', alpha=0.7, 
                label=f'Trung b√¨nh: {avg_count:.1f}')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # ƒê·∫£m b·∫£o output folder t·ªìn t·∫°i
    os.makedirs(config['OUTPUT_FOLDER'], exist_ok=True)
    
    plt.tight_layout()
    plt.savefig(os.path.join(config['OUTPUT_FOLDER'], 'class_distribution.png'), dpi=PLOT_DPI, bbox_inches='tight')
    
    # Ch·ªâ hi·ªÉn th·ªã n·∫øu ƒë∆∞·ª£c c·∫•u h√¨nh
    if config.get('SHOW_PLOTS', False):
        plt.show()
    else:
        plt.close()  # ƒê√≥ng figure ƒë·ªÉ ti·∫øt ki·ªám memory
    
    print(f"üìä ƒê·ªì th·ªã ph√¢n b·ªë class ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o: {config['OUTPUT_FOLDER']}/class_distribution.png")
    
    return {
        'class_names': class_names,
        'class_counts': class_counts,
        'total_images': sum(class_counts),
        'avg_count': avg_count
    }

def create_augmentation_comparison_chart(dataset_path, config, aug_stats):
    """
    T·∫°o ƒë·ªì th·ªã so s√°nh s·ªë l∆∞·ª£ng ·∫£nh tr∆∞·ªõc v√† sau augmentation
    """
    PLOT_DPI = config['PLOT_DPI']
    
    if not os.path.exists(dataset_path):
        print(f"‚ùå Th∆∞ m·ª•c {dataset_path} kh√¥ng t·ªìn t·∫°i!")
        return None
    
    print("üîç ƒêang t·∫°o ƒë·ªì th·ªã so s√°nh augmentation...")
    
    # L·∫•y th√¥ng tin c√°c class
    class_names = []
    original_counts = []
    
    for class_name in sorted(os.listdir(dataset_path)):
        class_path = os.path.join(dataset_path, class_name)
        if os.path.isdir(class_path):
            # ƒê·∫øm s·ªë file ·∫£nh trong class
            image_extensions = ['.jpg', '.jpeg', '.png', '.bmp', '.tiff', '.tif', '.gif', '.webp']
            count = 0
            for file in os.listdir(class_path):
                file_lower = file.lower()
                if any(file_lower.endswith(ext) for ext in image_extensions):
                    count += 1
            
            if count > 0:
                class_names.append(class_name)
                original_counts.append(count)
    
    if not class_names:
        print("‚ùå Kh√¥ng t√¨m th·∫•y ·∫£nh n√†o!")
        return None
    
    # T√≠nh to√°n s·ªë l∆∞·ª£ng ·∫£nh sau augmentation
    if config.get('USE_AUGMENTATION', False):
        # T√≠nh augmentation cho t·ª´ng class
        augmented_counts = []
        for i, class_name in enumerate(class_names):
            original_count = original_counts[i]
            
            # Ki·ªÉm tra xem class n√†y c√≥ ƒë∆∞·ª£c augment kh√¥ng
            should_augment = True
            if config.get('CLASS_AUGMENTATION', {}).get('enable_selective', False):
                class_aug_config = config['CLASS_AUGMENTATION']
                # Chuy·ªÉn t√™n class th√†nh index (n·∫øu c·∫ßn)
                class_index = i  # Gi·∫£ s·ª≠ th·ª© t·ª± class trong dataset
                
                if class_index in class_aug_config.get('skip_classes', []):
                    should_augment = False
                elif class_aug_config.get('augment_classes') and class_index not in class_aug_config['augment_classes']:
                    should_augment = False
            
            if should_augment:
                # T√≠nh s·ªë ·∫£nh ƒë∆∞·ª£c augment cho class n√†y
                augment_ratio = config.get('CLASS_AUGMENTATION', {}).get('augment_ratio', 1.5)
                augmented_count = int(original_count * augment_ratio)
            else:
                augmented_count = original_count
            
            augmented_counts.append(augmented_count)
    else:
        # Kh√¥ng c√≥ augmentation
        augmented_counts = original_counts.copy()
    
    # T·∫°o ƒë·ªì th·ªã so s√°nh
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(20, 8))
    
    # 1. Bar chart so s√°nh tr∆∞·ªõc v√† sau augmentation
    x = np.arange(len(class_names))
    width = 0.35
    
    bars1 = ax1.bar(x - width/2, original_counts, width, label='Tr∆∞·ªõc Augmentation', 
                    color='lightblue', edgecolor='navy', alpha=0.7)
    bars2 = ax1.bar(x + width/2, augmented_counts, width, label='Sau Augmentation', 
                    color='lightcoral', edgecolor='darkred', alpha=0.7)
    
    ax1.set_title('So s√°nh s·ªë l∆∞·ª£ng ·∫£nh tr∆∞·ªõc v√† sau Augmentation', fontsize=16, fontweight='bold')
    ax1.set_xlabel('Class', fontsize=12)
    ax1.set_ylabel('S·ªë l∆∞·ª£ng ·∫£nh', fontsize=12)
    ax1.set_xticks(x)
    ax1.set_xticklabels(class_names, rotation=45, ha='right')
    ax1.legend()
    ax1.grid(True, alpha=0.3)
    
    # Th√™m s·ªë li·ªáu tr√™n bars
    for bar in bars1:
        height = bar.get_height()
        ax1.text(bar.get_x() + bar.get_width()/2., height + max(augmented_counts)*0.01,
                f'{int(height)}', ha='center', va='bottom', fontweight='bold', fontsize=8)
    
    for bar in bars2:
        height = bar.get_height()
        ax1.text(bar.get_x() + bar.get_width()/2., height + max(augmented_counts)*0.01,
                f'{int(height)}', ha='center', va='bottom', fontweight='bold', fontsize=8)
    
    # 2. Pie chart t·ª∑ l·ªá augmentation
    total_original = sum(original_counts)
    total_augmented = sum(augmented_counts)
    total_increase = total_augmented - total_original
    
    labels = ['·∫¢nh g·ªëc', '·∫¢nh ƒë∆∞·ª£c augment']
    sizes = [total_original, total_increase]
    colors = ['lightblue', 'lightcoral']
    
    wedges, texts, autotexts = ax2.pie(sizes, labels=labels, autopct='%1.1f%%', 
                                       colors=colors, startangle=90)
    ax2.set_title('T·ª∑ l·ªá ·∫£nh g·ªëc vs ·∫£nh ƒë∆∞·ª£c augment', fontsize=16, fontweight='bold')
    
    # Th√™m th√¥ng tin t·ªïng quan
    fig.suptitle('PH√ÇN T√çCH DATA AUGMENTATION', fontsize=18, fontweight='bold', y=0.95)
    

    
    # ƒê·∫£m b·∫£o output folder t·ªìn t·∫°i
    os.makedirs(config['OUTPUT_FOLDER'], exist_ok=True)
    
    plt.tight_layout()
    plt.savefig(os.path.join(config['OUTPUT_FOLDER'], 'augmentation_comparison.png'), dpi=PLOT_DPI, bbox_inches='tight')
    
    # Ch·ªâ hi·ªÉn th·ªã n·∫øu ƒë∆∞·ª£c c·∫•u h√¨nh
    if config.get('SHOW_PLOTS', False):
        plt.show()
    else:
        plt.close()  # ƒê√≥ng figure ƒë·ªÉ ti·∫øt ki·ªám memory
    
    print(f"üìä ƒê·ªì th·ªã so s√°nh augmentation ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o: {config['OUTPUT_FOLDER']}/augmentation_comparison.png")
    
    return {
        'class_names': class_names,
        'original_counts': original_counts,
        'augmented_counts': augmented_counts,
        'total_original': total_original,
        'total_augmented': total_augmented,
        'total_increase': total_increase
    }

def analyze_and_visualize_dataset(dataset_path, config):
    """
    Ph√¢n t√≠ch dataset v√† tr·∫£ v·ªÅ th√¥ng tin (kh√¥ng t·∫°o ƒë·ªì th·ªã)
    """
    if not os.path.exists(dataset_path):
        print(f"‚ùå Th∆∞ m·ª•c {dataset_path} kh√¥ng t·ªìn t·∫°i!")
        return None
    
    print("üîç ƒêang ph√¢n t√≠ch dataset...")
    
    # L·∫•y th√¥ng tin c√°c class
    class_names = []
    class_counts = []
    class_distribution = {}
    
    for class_name in sorted(os.listdir(dataset_path)):
        class_path = os.path.join(dataset_path, class_name)
        if os.path.isdir(class_path):
            # ƒê·∫øm s·ªë file ·∫£nh trong class
            image_extensions = ['.jpg', '.jpeg', '.png', '.bmp', '.tiff', '.tif', '.gif', '.webp']
            count = 0
            for file in os.listdir(class_path):
                file_lower = file.lower()
                if any(file_lower.endswith(ext) for ext in image_extensions):
                    count += 1
            
            if count > 0:
                class_names.append(class_name)
                class_counts.append(count)
                class_distribution[class_name] = count
    
    if not class_names:
        print("‚ùå Kh√¥ng t√¨m th·∫•y ·∫£nh n√†o!")
        return None
    
    total_images = sum(class_counts)
    avg_count = np.mean(class_counts)
    min_count = min(class_counts)
    max_count = max(class_counts)
    
    print(f"‚úÖ Ph√¢n t√≠ch dataset ho√†n th√†nh!")
    print(f"üìä T·ªïng s·ªë class: {len(class_names)}")
    print(f"üìä T·ªïng s·ªë ·∫£nh: {total_images:,}")
    print(f"üìä Trung b√¨nh ·∫£nh/class: {avg_count:.1f}")
    print(f"üìä √çt nh·∫•t: {min_count} ·∫£nh")
    print(f"üìä Nhi·ªÅu nh·∫•t: {max_count} ·∫£nh")
    
    return {
        'class_names': class_names,
        'class_counts': class_counts,
        'class_distribution': class_distribution,
        'total_images': total_images,
        'avg_count': avg_count,
        'min_count': min_count,
        'max_count': max_count
    }
